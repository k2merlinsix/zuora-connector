/**
 * Mule Zuora Cloud Connector
 *
 * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com
 *
 * The software in this package is published under the terms of the CPAL v1.0
 * license, a copy of which has been included with this distribution in the
 * LICENSE.txt file.
 */

/**
 * This file was automatically generated by the Mule Development Kit
 */
package org.mule.modules.zuora;

import org.mule.api.annotations.Configurable;
import org.mule.api.annotations.Module;
import org.mule.api.annotations.Processor;
import org.mule.api.annotations.param.Optional;
import org.mule.modules.zuora.zobject.DynamicZObject;
import org.mule.modules.zuora.zobject.ZObject;
import org.mule.modules.zuora.zobject.ZObjectType;
import org.mule.modules.zuora.zuora.api.SfdcZuoraClient;
import org.mule.modules.zuora.zuora.api.ZuoraClient;
import org.mule.modules.zuora.zuora.api.ZuoraClientAdaptor;
import org.mule.modules.zuora.zuora.api.ZuoraException;

import com.zuora.api.object.AmendRequest;
import com.zuora.api.object.AmendResult;
import com.zuora.api.object.DeleteResult;
import com.zuora.api.object.SaveResult;
import com.zuora.api.object.SubscribeRequest;
import com.zuora.api.object.SubscribeResult;

import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.collections.Transformer;
import org.apache.commons.lang.StringUtils;

/**
 * @author flbulgarelli
 */
@Module(name="zuora",
        namespace="http://repository.mulesoft.org/releases/org/mule/modules/mule-module-zuora",
        schemaLocation="http://repository.mulesoft.org/releases/org/mule/modules/mule-module-zuora/1.0/mule-zuora.xsd")
public class ZuoraModule 
{
    @Configurable
    @Optional
    private ZuoraClient<ZuoraException> client;
    @Configurable
    private String username;
    @Configurable
    private String password;
    @Configurable
    private String endpoint;
    @Optional
    @Configurable
    private String proxyHost;
    @Optional
    @Configurable
    private String proxyUsername;
    @Optional
    @Configurable
    private Integer proxyPort;
    @Optional
    @Configurable
    private String proxyPassword;
    
    /**
     * Batch creation of ZObjects associated to Subscriptions
     *
     * {@code <subscribe subscriptions-ref="#[variable:subscribtions]"/>} 
     * @param subscriptions
     * @return a subscription results list, one for each subscription 
     */
    @Processor
    public List<SubscribeResult> subscribe(List<SubscribeRequest> subscriptions)
    {
        return client.subscribe(subscriptions);
    }

    /**
     * Batch creation of ZObjects
     *
     * {@code <create>
     *          <zobjects>
     *              <zobject ref="#[variable:anObject]"/>
     *           </zobject>
     *         </create>}   
     * @param zobjects the zobjects to create
     * @param type the type of zobject passed
     * @return a list of SaveResult, one for each ZObject  
     */
    @Processor
    public List<SaveResult> create(ZObjectType type, List<Map<String, Object>> zobjects)
    {
        return client.create(mapToZObject(type, zobjects));
    }
    
    /**
     * Batch creation of invoces for accounts
     * 
     * {@code <generate zobjects-ref="#[variable:accounts]"/>}
     * @param zobjects the zobjects to generate
     * @param type the type of zobject passed
     * 
     * @return a list of SaveResult, one for each ZObject
     */
    @Processor
    public List<SaveResult> generate(ZObjectType type, List<Map<String, Object>> zobjects)
    {
        return client.generate(mapToZObject(type, zobjects));
    }

    /**
     * Batch update of ZObjects
     *
     * {@code <update zobjects-ref="#[variable:objects]"/>}
     * @param zobjects the zobjects to update
     * @param type the type of zobject passed
     * @return a list of SaveResult, one for each ZObject 
     */
    @Processor
    public List<SaveResult> update(ZObjectType type, List<Map<String, Object>> zobjects)
    {
        return client.update(mapToZObject(type, zobjects));
    }
    
    /**
     * Batch delete of ZObjects
     * 
     * {@code <delete ids-ref="#[variable:ids]" type="#[variable:zobjectType]"/>}
     * @param type the type of ZObjects to delete 
     * @param ids 
     * @return a list of DeleteResults, one for each id 
     */
    @Processor
    public List<DeleteResult> delete(ZObjectType type, List<String> ids)
    {
        return client.delete(type.getTypeName(), ids);
    }
    
    /**
     * Lazily retrieves ZObject that match a given query, 
     * written in Zuora native query language
     *
     * {@code <find query="#[header:queryString]" />}
     * @param zquery
     * @return a ZObjects iterable
     */
    @Processor
    public Iterable<ZObject> find(String zquery)
    {
        return client.find(zquery);
    }
    
    /**
     * Answers user information
     *
     * {@code <get-user-info userId="#[header:userId]""/>}
     * @return a User 
     */
    @Processor
    public String getUserInfo()
    {
        return client.getUserInfo();
    }
    
    /**
     * Amends subscriptions
     *
     * {@code <amend amendaments-ref="#[header:amendamentsList]"/>}
     * @param amendaments 
     * @return a list of AmmendResults, one for each amendament
     */
    @Processor
    public List<AmendResult> amend(List<AmendRequest> amendaments)
    {
        return client.amend(amendaments);
    }    
    
     //@Start
    public void init() throws Exception
    {
        if (client == null)
        {
            setClient(new SfdcZuoraClient(username, password, endpoint, proxyHost, proxyUsername,
                proxyPassword, proxyPort));
        }
    }
    
    public String getPassword()
    {
        return password;
    }
    
    public String getUsername()
    {
        return username;
    }
    
    public void setPassword(String password)
    {
        this.password = password;
    }
    
    public void setUsername(String username)
    {
        this.username = username;
    }
    
    public void setClient(ZuoraClient<?> client)
    {
        this.client = ZuoraClientAdaptor.adapt(client);
    }
    
    public void setEndpoint(String enpoint)
    {
        this.endpoint = enpoint;
    }
    
    public String getEnpoint()
    {
        return endpoint;
    }
    
    private ZObject toZObject(ZObjectType type, Map<String, Object> map)
    {
        DynamicZObject zobject = new DynamicZObject();
        for (Entry<String, Object> entry : map.entrySet())
        {
            zobject.setField(StringUtils.capitalize(entry.getKey()), entry.getValue());
        }
        zobject.setXmlType(type.getTypeName());
        return zobject;
    }
    
    @SuppressWarnings("unchecked")
    private List<ZObject> mapToZObject(final ZObjectType type, List<Map<String, Object>> maps)
    {
        return (List<ZObject>) CollectionUtils.collect(maps, new Transformer()
        {
            @Override
            public Object transform(Object input)
            {
                return toZObject(type, (Map<String, Object>) input);
            }
        });
    }
}
